--[[
OVERDOORS ‚Äî Full single-file (Seek music merged)
Features:
- Caption on load: "OVERDOORS BY CH√ö B√â T√ä LI·ªÜT,"
- Caption on room1: "good luck üëçüóø" (one-time)
- PurpleFlashlight given at room1 (one-time)
- Random entity scheduler (sparse per-room)
- Guiding Light at room 45 (one-time)
- Room2: caption "loaded successfully" + intro music
- SEEK music handler integrated (replacement music plays & cleans up)
- Executor-friendly, guarded (won't double-load)
]]

if getgenv().OVERDOORS_FULL_LOADED then
	print("[OVERDOORS] already loaded")
	return
end
getgenv().OVERDOORS_FULL_LOADED = true

-- Services
local Players = game:GetService("Players")
local RS = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local Workspace = game:GetService("Workspace")
local ContentProvider = game:GetService("ContentProvider")
local SoundService = game:GetService("SoundService")

local LocalPlayer = Players.LocalPlayer

-- Safe helper
local function safe(f, ...) local ok, a = pcall(f, ...) if not ok then return false, a end return true, a end

local function log(...) print("[OVERDOORS]", ...) end

-- Wait for GameData.LatestRoom in background (so other parts can use LatestRoom)
task.spawn(function()
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do
		task.wait(0.4)
	end
end)

--------------------------------------------------
-- CAPTION (MainGame.caption) - initial & room1
--------------------------------------------------
task.spawn(function()
	-- wait UI
	local tries = 0
	repeat
		task.wait(0.5)
		tries = tries + 1
		if tries > 30 then break end
	until (LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI") and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game"))

	local MainGame
	local ok
	if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI") and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game") then
		ok, MainGame = pcall(function() return require(LocalPlayer.PlayerGui.MainUI.Initiator.Main_Game) end)
		if not ok or not MainGame or type(MainGame.caption) ~= "function" then
			MainGame = nil
		end
	end

	-- show startup caption
	if MainGame then
		pcall(function() MainGame.caption("OVERDOORS BY CH√ö B√â T√ä LI·ªÜT,", true) end)
	else
		-- fallback quick GUI
		task.spawn(function()
			task.wait(0.4)
			if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
				safe(function()
					local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn=false; g.Name="OD_CAP_FALLBACK"
					local l = Instance.new("TextLabel", g)
					l.Size = UDim2.fromScale(1,0.08); l.Position = UDim2.fromScale(0,0.45)
					l.BackgroundTransparency = 1; l.TextScaled=true; l.Font=Enum.Font.GothamBold
					l.Text = "OVERDOORS BY CH√ö B√â T√ä LI·ªÜT,"; Debris:AddItem(g,6)
				end)
			end
		end)
	end

	-- watch room 1 -> caption + PurpleFlashlight is handled elsewhere (see room1 block)
	if workspace:FindFirstChild("CurrentRooms") then
		workspace.CurrentRooms.ChildAdded:Connect(function(room)
			local rn = tonumber(room.Name)
			if rn == 1 then
				task.wait(0.2)
				if MainGame then
					pcall(function() MainGame.caption("good luck üëçüóø", true) end)
				else
					-- fallback: quick GUI
					if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
						pcall(function()
							local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn=false; g.Name="OD_CAP_ROOM1"
							local l = Instance.new("TextLabel", g)
							l.Size = UDim2.fromScale(1,0.06); l.Position = UDim2.fromScale(0,0.88)
							l.BackgroundTransparency = 1; l.TextScaled=true; l.Font=Enum.Font.GothamBold
							l.TextColor3 = Color3.fromRGB(170,255,200); l.Text = "good luck üëçüóø"
							Debris:AddItem(g,6)
						end)
					end
				end
			end
		end)
	end
end)

--------------------------------------------------
-- SAFE REMOTE LOADER (pcall + loadstring)
--------------------------------------------------
local function safeLoadRemote(url)
	if not url or url == "" then return false, "no url" end
	local ok, body = pcall(function() return game:HttpGet(url, true) end)
	if not ok or not body or #body < 8 then return false, "fetch failed" end
	body = body:gsub("(%d%d%d%d%d+)", "1")
	local fn, err = loadstring(body)
	if not fn then return false, ("loadstring err: %s"):format(tostring(err)) end
	local suc, rerr = pcall(fn)
	if not suc then return false, ("runtime err: %s"):format(tostring(rerr)) end
	return true
end

--------------------------------------------------
-- INTRO IMAGE (safe)
--------------------------------------------------
task.spawn(function()
	task.wait(0.6)
	if not LocalPlayer or not LocalPlayer:FindFirstChild("PlayerGui") then return end
	local gui = Instance.new("ScreenGui", LocalPlayer.PlayerGui)
	gui.Name = "OD_INTRO_IMAGE"
	gui.ResetOnSpawn = false
	local img = Instance.new("ImageLabel", gui)
	img.Size = UDim2.fromScale(1,1); img.BackgroundTransparency = 1; img.ScaleType = Enum.ScaleType.Fit
	img.Image = "rbxassetid://93664194964832"
	img.ImageTransparency = 1
	for i=1,12 do img.ImageTransparency = img.ImageTransparency - 0.08; task.wait(0.03) end
	task.wait(1.6)
	for i=1,12 do img.ImageTransparency = img.ImageTransparency + 0.08; task.wait(0.03) end
	gui:Destroy()
end)

--------------------------------------------------
-- PLAYER STATS (safe)
--------------------------------------------------
task.spawn(function()
	while task.wait(1) do
		safe(function()
			local h = LocalPlayer and LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
			if h then
				h.WalkSpeed = 20
				h.JumpPower = 38
			end
		end)
	end
end)

--------------------------------------------------
-- ENTITIES: list
--------------------------------------------------
local ENTITY_URLS = {
	"https://raw.githubusercontent.com/Junbbinopro/Depth-entity/refs/heads/main/Depth",
	"https://raw.githubusercontent.com/Junbbinopro/Guardian-entity/refs/heads/main/Guardian",
	"https://raw.githubusercontent.com/Junbbinopro/Wh1t3/refs/heads/main/Entity",
	"https://raw.githubusercontent.com/trungdepth-dot/Entity-greance/refs/heads/main/Greance-20",
	"https://raw.githubusercontent.com/binhlforsaken156-sys/Hauntstep-entity/refs/heads/main/OVERDOORS%20HAUNTSTEP%20ENTYTY.lua",
	"https://raw.githubusercontent.com/Zeca130/doors-my-version-nightmareMode./refs/heads/main/Entity6",
	"https://raw.githubusercontent.com/Idk-lol2/a-60aa/refs/heads/main/---======%20a-60%20agresiv%20spawner%20======---.txt",
	"https://github.com/PABMAXICHAC/doors-monsters-scripts/raw/main/blinkcrux"
}

--------------------------------------------------
-- RANDOM ROOM SCHEDULER (no %)
--------------------------------------------------
task.spawn(function()
	-- wait LatestRoom
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.4) end
	local LatestRoom = RS.GameData.LatestRoom
	local lastRoom = LatestRoom.Value or 0
	local function scheduleNext(fromRoom) return (fromRoom or lastRoom) + math.random(3,7) end
	getgenv().OVERDOORS_nextEntityRoom = getgenv().OVERDOORS_nextEntityRoom or scheduleNext(lastRoom)
	local nextSpawn = getgenv().OVERDOORS_nextEntityRoom
	local busy = false

	LatestRoom.Changed:Connect(function()
		local cur = LatestRoom.Value or 0
		if cur <= lastRoom then lastRoom = cur; return end
		lastRoom = cur
		if cur == nextSpawn then
			if not busy then
				busy = true
				task.spawn(function()
					-- avoid spawning if an entity exists
					local found = false
					for _,m in ipairs(Workspace:GetChildren()) do
						if m:IsA("Model") then
							local n = tostring(m.Name):lower()
							if n:find("repentance") or n:find("seek") or n:find("ambush") or n:find("rush") then found = true; break end
						end
					end
					if not found then
						local url = ENTITY_URLS[math.random(#ENTITY_URLS)]
						local ok, err = safeLoadRemote(url)
						if ok then log("spawned entity from", url) else log("spawn failed:", err) end
					else
						log("entity present, skip spawn")
					end
					task.wait(2)
					busy = false
				end)
			end
			nextSpawn = scheduleNext(cur)
			getgenv().OVERDOORS_nextEntityRoom = nextSpawn
			log("next entity scheduled at room", nextSpawn)
		end
	end)
end)

--------------------------------------------------
-- Purple flashlight at room 1 (one-time)
--------------------------------------------------
task.spawn(function()
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.4) end
	local LatestRoom = RS.GameData.LatestRoom
	if not getgenv().PURPLE_FLASHLIGHT_GIVEN then getgenv().PURPLE_FLASHLIGHT_GIVEN = false end
	LatestRoom.Changed:Connect(function(v)
		if v == 1 and not getgenv().PURPLE_FLASHLIGHT_GIVEN then
			getgenv().PURPLE_FLASHLIGHT_GIVEN = true
			task.spawn(function()
				local ok, err = safeLoadRemote("https://raw.githubusercontent.com/thelostw3r/Scripts/refs/heads/main/PurpleFlashlight.lua")
				if ok then log("PurpleFlashlight given") else log("PurpleFlashlight failed:", err) end
			end)
		end
	end)
end)

--------------------------------------------------
-- GUIDING LIGHT (ROOM 45 ONLY, ONE-TIME)
--------------------------------------------------
task.spawn(function()
	-- wait gamedata
	while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.5) end
	local LatestRoom = RS.GameData.LatestRoom
	local TRIGGER_ROOM = 45
	local triggered = false

	LatestRoom.Changed:Connect(function()
		if triggered then return end
		if LatestRoom.Value == TRIGGER_ROOM then
			triggered = true
			task.spawn(function()
				if not LocalPlayer or not LocalPlayer:FindFirstChild("PlayerGui") then return end
				local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.Name="GUIDING_ROOM_45"; g.ResetOnSpawn=false
				local t = Instance.new("TextLabel", g)
				t.Size = UDim2.fromScale(1,0.16); t.Position = UDim2.fromScale(0,0.42)
				t.BackgroundTransparency = 1; t.TextScaled=true; t.Font = Enum.Font.GothamBold
				t.TextColor3 = Color3.fromRGB(0,210,255); t.TextStrokeTransparency = 0.6
				t.Text = "Do you really trust me?"
				Debris:AddItem(g, 2)
			end)
			log("Guiding Light triggered at room 45")
		end
	end)
end)

--------------------------------------------------
-- ROOM2: caption + intro music
--------------------------------------------------
do
	local ROOM2_SOUNDID = "rbxassetid://110788401793874"
	local ROOM2_VOLUME = 1
	local ROOM2_NAME = "OD_ROOM2_INTRO"
	task.spawn(function()
		while not (RS:FindFirstChild("GameData") and RS.GameData:FindFirstChild("LatestRoom")) do task.wait(0.3) end
		local LatestRoom = RS.GameData.LatestRoom

		-- get MainGame if possible
		local MainGame = nil
		local tries = 0
		repeat
			task.wait(0.4); tries = tries + 1
			if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") and LocalPlayer.PlayerGui:FindFirstChild("MainUI")
				and LocalPlayer.PlayerGui.MainUI:FindFirstChild("Initiator") and LocalPlayer.PlayerGui.MainUI.Initiator:FindFirstChild("Main_Game") then
				local ok,mod = pcall(function() return require(LocalPlayer.PlayerGui.MainUI.Initiator.Main_Game) end)
				if ok and mod and type(mod.caption) == "function" then MainGame = mod; break end
			end
		until tries >= 30

		local function playRoom2Intro()
			-- avoid duplicates
			for _,s in ipairs(SoundService:GetChildren()) do
				if s:IsA("Sound") and s.Name == ROOM2_NAME then
					if s.Playing then return end
					pcall(function() s:Destroy() end)
				end
			end
			local s = Instance.new("Sound")
			s.Name = ROOM2_NAME; s.SoundId = ROOM2_SOUNDID; s.Volume = ROOM2_VOLUME; s.Looped = false; s.Parent = SoundService
			pcall(function() ContentProvider:PreloadAsync({s}) end)
			task.spawn(function() task.wait(0.05); pcall(function() s:Play() end) end)
			local conn; conn = s.Ended:Connect(function() if conn then conn:Disconnect() end; pcall(function() s:Destroy() end) end)
			task.delay(120, function() pcall(function() s:Destroy() end) end)
			log("Room2 intro started (id:", ROOM2_SOUNDID, "vol:", ROOM2_VOLUME, ")")
		end

		LatestRoom.Changed:Connect(function(v)
			local rn = tonumber(v) or tonumber(LatestRoom.Value) or nil
			if rn == 2 then
				log("Entered room 2 -> caption + intro")
				-- caption
				if MainGame then
					pcall(function() MainGame.caption("loaded successfully", true) end)
				else
					-- fallback GUI
					if LocalPlayer and LocalPlayer:FindFirstChild("PlayerGui") then
						pcall(function()
							local g = Instance.new("ScreenGui", LocalPlayer.PlayerGui); g.ResetOnSpawn=false; g.Name="OD_LOADED_CAP"
							local lbl = Instance.new("TextLabel", g)
							lbl.Size = UDim2.fromScale(1,0.06); lbl.Position = UDim2.fromScale(0,0.88)
							lbl.BackgroundTransparency = 1; lbl.TextScaled=true; lbl.Font=Enum.Font.GothamBold
							lbl.TextColor3 = Color3.fromRGB(170,255,200); lbl.Text = "loaded successfully"
							Debris:AddItem(g,3)
						end)
					end
				end
				-- play music
				pcall(playRoom2Intro)
			end
		end)
	end)
end

--------------------------------------------------
-- ===== SEEK MUSIC HANDLER (integrated) =====
-- Replacement music will play when a Seek-like model spawns or when the original Seek sound ends.
--------------------------------------------------
do
	-- config
	local TARGET_SOUNDID = "rbxassetid://123602120579597" -- replacement Seek music (updated)
	local TARGET_VOLUME = 4
	local CUTSCENE_WAIT = 0.9
	local SYNC_OFFSET = 0.12
	local FALLBACK_TIMEOUT = 8

	local activeMusicForModel = {} -- model -> {sound, conn}

	local function makeClientSound()
		local cam = Workspace.CurrentCamera or Workspace
		local s = Instance.new("Sound")
		s.Name = "OD_SEEK_REPL"
		s.SoundId = TARGET_SOUNDID
		s.Volume = TARGET_VOLUME
		s.Looped = false
		s.Parent = cam
		pcall(function() ContentProvider:PreloadAsync({s}) end)
		return s
	end

	local function cleanupModelMusic(model)
		local info = activeMusicForModel[model]
		if not info then return end
		if info.conn then pcall(function() info.conn:Disconnect() end) end
		if info.sound then pcall(function() info.sound:Stop() end); pcall(function() info.sound:Destroy() end) end
		activeMusicForModel[model] = nil
		log("cleanup music for", model.Name or "<model>")
	end

	local function startReplacementForModel(model, startPos)
		if activeMusicForModel[model] then return end
		local s = makeClientSound()
		activeMusicForModel[model] = { sound = s }
		activeMusicForModel[model].conn = model.AncestryChanged:Connect(function(_,parent) if not parent then cleanupModelMusic(model) end end)
		task.spawn(function() task.wait(0.03); pcall(function() if startPos and type(startPos)=="number" then s.TimePosition = math.max(0, startPos + SYNC_OFFSET) end; s:Play() end) end)
		local conn; conn = s.Ended:Connect(function() if conn then conn:Disconnect() end; cleanupModelMusic(model) end)
		log("started replacement for", model.Name or "<model>")
	end

	local function handleOriginalSeekSound(orig)
		if not orig or not orig.Parent then return end
		local top = orig
		while top and not top:IsA("Model") and top.Parent do top = top.Parent end
		if not top or not top:IsA("Model") then top = orig.Parent end
		if activeMusicForModel[top] then return end
		if orig:GetAttribute("OD_HANDLED") then return end
		orig:SetAttribute("OD_HANDLED", true)

		local function onEndedPlay() local pos = 0; pcall(function() pos = orig.TimePosition end); startReplacementForModel(top, pos) end

		if orig.Playing then
			log("original seek sound playing ‚Äî waiting to stop to start replacement")
			local ch; ch = orig:GetPropertyChangedSignal("Playing"):Connect(function()
				local ok,val = pcall(function() return orig.Playing end)
				if ok and not val then if ch then ch:Disconnect() end; onEndedPlay() end
			end)
			task.delay(FALLBACK_TIMEOUT, function() if activeMusicForModel[top] then return end; if ch then pcall(function() ch:Disconnect() end) end; log("fallback start replacement"); onEndedPlay() end)
		else
			log("listening for original seek to start then stop")
			local cs; cs = orig:GetPropertyChangedSignal("Playing"):Connect(function()
				local ok,val = pcall(function() return orig.Playing end)
				if ok and val then if cs then cs:Disconnect() end
					local cs2; cs2 = orig:GetPropertyChangedSignal("Playing"):Connect(function()
						local ok2,val2 = pcall(function() return orig.Playing end)
						if ok2 and not val2 then if cs2 then cs2:Disconnect() end; onEndedPlay() end
					end)
					task.delay(FALLBACK_TIMEOUT, function() if activeMusicForModel[top] then return end; if cs2 then pcall(function() cs2:Disconnect() end) end; log("fallback after wait-start-stop"); onEndedPlay() end)
				end
			end)
		end
	end

	local function isSeekishModel(m)
		if not m or not m:IsA("Model") then return false end
		local n = tostring(m.Name):lower()
		if n:find("seek") or n:find("c00lkidd") or n:find("kiddo") or n:find("seekmoving") then return true end
		return false
	end

	local function onSeekModel(model)
		if activeMusicForModel[model] then return end
		-- look for original sound
		local orig = nil
		for _,d in ipairs(model:GetDescendants()) do if d:IsA("Sound") and tostring(d.Name):lower():find("seek") then orig = d; break end end
		if orig then
			log("found original seek Sound in model:", model:GetFullName())
			pcall(handleOriginalSeekSound, orig); return
		end
		-- fallback wait then play
		log("no original sound found in model; waiting", CUTSCENE_WAIT, "s before fallback")
		task.spawn(function()
			task.wait(CUTSCENE_WAIT)
			if not model.Parent then return end
			local foundNow = nil
			for _,d in ipairs(model:GetDescendants()) do if d:IsA("Sound") and tostring(d.Name):lower():find("seek") then foundNow = d; break end end
			if foundNow then pcall(handleOriginalSeekSound, foundNow); return end
			startReplacementForModel(model, 0)
		end)
	end

	-- watchers
	Workspace.DescendantAdded:Connect(function(desc)
		task.defer(function()
			if desc:IsA("Model") and isSeekishModel(desc) then onSeekModel(desc)
			else
				if desc:IsA("Sound") and tostring(desc.Name):lower():find("seek") then pcall(handleOriginalSeekSound, desc) end
				for _,v in ipairs(desc:GetDescendants()) do
					if v:IsA("Model") and isSeekishModel(v) then onSeekModel(v); break
					elseif v:IsA("Sound") and tostring(v.Name):lower():find("seek") then pcall(handleOriginalSeekSound, v); break end
				end
			end
		end)
	end)

	-- initial scan
	for _,v in ipairs(Workspace:GetDescendants()) do
		if v:IsA("Model") and isSeekishModel(v) then onSeekModel(v)
		elseif v:IsA("Sound") and tostring(v.Name):lower():find("seek") then pcall(handleOriginalSeekSound, v) end
	end

	log("SEEK handler integrated. Replacement id:", TARGET_SOUNDID)
end

--------------------------------------------------
-- READY
--------------------------------------------------
log("‚úÖ OVERDOORS FULL LOADED ‚Äî integrated SEEK music + room handlers")
